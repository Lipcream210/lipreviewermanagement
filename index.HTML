<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Reviewer</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    /* … your existing styles here … */
    .next-btn { margin: 5px; }
  </style>
</head>
<body>
  <button onclick="openTab('review')">Review</button>
  <button onclick="openTab('manage')">Manage Questions</button>

  <div id="review" class="tab active">
    <h2 class="review-header">DECK MANAGEMENT LEVEL REVIEW</h2>
    <select id="subjectSelect" onchange="startQuiz()">
      <option value="">Select a Subject</option>
      <!-- F1–F20 except F7, F18 -->
      <option>F1</option><option>F2</option><option>F3</option><option>F4</option>
      <option>F5</option><option>F6</option><option>F8</option><option>F9</option>
      <option>F10</option><option>F11</option><option>F12</option><option>F13</option>
      <option>F14</option><option>F15</option><option>F16</option><option>F17</option>
      <option>F19</option><option>F20</option>
    </select>
    <div id="quizContainer"></div>
    <p id="score">0 / 0 (Answered: 0)</p>
    <div id="controlButtons">
      <div id="nextButtonContainer"></div>
      <button onclick="resetQuiz()">Reset Quiz</button>
    </div>
  </div>

  <div id="manage" class="tab">
    <!-- … your manage-tab markup … -->
  </div>

  <script>
    const MANAGE_PASSWORD = 'lipcream';

    function openTab(tabName) {
      if (tabName === 'manage') {
        const pass = prompt('Enter password to access Manage Questions:');
        if (pass !== MANAGE_PASSWORD) return alert('Incorrect password');
        let last = document.getElementById('subjectSelect').value || 'F1';
        document.getElementById('manageSubjectSelect').value = last;
        loadQuestions();
      }
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if (tabName === 'review') {
        const sub = document.getElementById('subjectSelect').value;
        if (sub) startQuiz();
      }
    }

    // --- Firebase Init ---
    firebase.initializeApp({
      apiKey: "...",
      authDomain: "lipreviewermanagement.firebaseapp.com",
      projectId: "lipreviewermanagement",
      storageBucket: "lipreviewermanagement.firebasestorage.app",
      messagingSenderId: "273852069277",
      appId: "1:273852069277:web:cdb76befc9c096e9e0ab74"
    });
    const db = firebase.firestore();

    // --- Quiz State ---
    let originalQuestions = [],
        quizQuestions     = [],
        correctQuestions  = [],
        incorrectQuestions= [],
        totalQuestions    = 0,
        currentSubject    = '',
        currentCorrect    = '',
        score             = 0,
        answeredCount     = 0;

    function startQuiz() {
      currentSubject = document.getElementById('subjectSelect').value;
      if (!currentSubject) return;
      score = answeredCount = 0;
      correctQuestions = [];
      incorrectQuestions = [];
      document.getElementById('score').innerText = '0 / 0 (Answered: 0)';
      db.collection('questions')
        .where('subject', '==', currentSubject)
        .get()
        .then(snapshot => {
          originalQuestions = snapshot.docs.map(d => d.data());
          quizQuestions     = originalQuestions.slice();
          totalQuestions    = quizQuestions.length;
          document.getElementById('score')
                  .innerText = `0 / ${totalQuestions} (Answered: 0)`;
          showNextQuestion();
        })
        .catch(console.error);
    }

    function showNextQuestion() {
      const container = document.getElementById('quizContainer');
      document.getElementById('nextButtonContainer').innerHTML = '';
      if (quizQuestions.length === 0) {
        return showSummary();
      }
      const idx = Math.floor(Math.random() * quizQuestions.length);
      const q   = quizQuestions.splice(idx, 1)[0];
      currentCorrect = q['option' + q.correctOption].trim();
      let opts = [q.optionA, q.optionB, q.optionC, q.optionD].map(o => o.trim());
      shuffle(opts);
      let html = `<p>${q.question}</p>`;
      opts.forEach((opt, i) => {
        const L = String.fromCharCode(65 + i);
        html += `<button data-opt="${opt}" onclick="checkAnswer('${opt}')">
                   ${L}: ${opt}
                 </button><br>`;
      });
      container.innerHTML = html;
    }

    function checkAnswer(selected) {
      answeredCount++;
      score += (selected.trim() === currentCorrect) ? (() => {
        correctQuestions.push(currentQuestion());
        return 1;
      })() : (() => {
        incorrectQuestions.push(currentQuestion());
        return 0;
      })();
      document.querySelectorAll('#quizContainer button')
              .forEach(btn => btn.disabled = true);
      document.querySelector(`#quizContainer button[data-opt="${selected}"]`)
              .classList.add(
                selected.trim() === currentCorrect ? 'correct' : 'wrong'
              );
      if (selected.trim() !== currentCorrect) {
        document.querySelector(`#quizContainer button[data-opt="${currentCorrect}"]`)
                .classList.add('correct');
      }
      document.getElementById('score')
              .innerText = `${score} / ${totalQuestions} (Answered: ${answeredCount})`;
      const next = document.createElement('button');
      next.innerText = 'Next';
      next.classList.add('next-btn');
      next.onclick = () => { next.remove(); showNextQuestion(); };
      document.getElementById('nextButtonContainer').appendChild(next);
    }

    function showSummary() {
      const container = document.getElementById('quizContainer');
      container.innerHTML = `
        <p>Quiz finished! ${score} / ${totalQuestions} (Answered: ${answeredCount})</p>
        ${correctQuestions.length>0
          ? '<button id="retakeCorrect" class="next-btn">Retake Correct</button>'
          : ''}
        <button id="retakeAll"      class="next-btn">Retake All</button>
        <button id="chooseSubject"  class="next-btn">Choose Another Subject</button>
      `;
      if (correctQuestions.length>0) {
        document.getElementById('retakeCorrect')
          .addEventListener('click', () => {
            quizQuestions = correctQuestions.slice();
            totalQuestions = quizQuestions.length;
            score = answeredCount = 0;
            document.getElementById('score')
                    .innerText = `0 / ${totalQuestions} (Answered: 0)`;
            showNextQuestion();
          });
      }
      document.getElementById('retakeAll')
        .addEventListener('click', () => {
          quizQuestions = originalQuestions.slice();
          totalQuestions = quizQuestions.length;
          score = answeredCount = 0;
          document.getElementById('score')
                  .innerText = `0 / ${totalQuestions} (Answered: 0)`;
          showNextQuestion();
        });
      document.getElementById('chooseSubject')
        .addEventListener('click', () => {
          document.getElementById('subjectSelect').value = '';
          container.innerHTML = '';
          document.getElementById('score')
                  .innerText = '0 / 0 (Answered: 0)';
        });
    }

    function resetQuiz() { startQuiz(); }

    function currentQuestion() {
      // last served question is the one we just answered
      // we can retrieve it by looking at answeredCount index
      // but simpler: re-add logic to pass it in checkAnswer
      // for brevity we’ll assume we saved it globally:
      return lastQuestion;
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
  </script>
</body>
</html>
